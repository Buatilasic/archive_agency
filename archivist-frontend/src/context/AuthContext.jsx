import React, { createContext, useState, useContext } from 'react';
import axios from 'axios';

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Axios: —Ç–µ–ø–µ—Ä—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å cookies üç™
axios.defaults.withCredentials = true;

// —Å–æ–∑–¥–∞—ë–º '—Å–ª—É–∂–µ–±–Ω—ã–π –∫–∞–Ω–∞–ª' (–∫–æ–Ω—Ç–µ–∫—Å—Ç) –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
const AuthContext = createContext(null);

// —ç—Ç–æ –Ω–∞—à –∫–æ–º–ø–æ–Ω–µ–Ω—Ç-–ø—Ä–æ–≤–∞–π–¥–µ—Ä. –æ–Ω –±—É–¥–µ—Ç '—Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å' –ø–æ –∫–∞–Ω–∞–ª—É, –∫—Ç–æ —Å–µ–π—á–∞—Å –≤ —Å–∏—Å—Ç–µ–º–µ.
export const AuthProvider = ({ children }) => {
    // –∑–¥–µ—Å—å –º—ã —Ö—Ä–∞–Ω–∏–º '–ª–∏—á–Ω–æ–µ –¥–µ–ª–æ' (–¥–∞–Ω–Ω—ã–µ) —Ç–µ–∫—É—â–µ–≥–æ –∞–≥–µ–Ω—Ç–∞. –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ ‚Äî –ø—É—Å—Ç–æ.
    const [currentUser, setCurrentUser] = useState(null);

    // —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è '–ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤' (–≤—Ö–æ–¥–∞).
    const login = async (loginData) => {
        try {
            // –£–±–µ–¥–∏—Å—å, —á—Ç–æ –∞–¥—Ä–µ—Å –∑–¥–µ—Å—å –∏–º–µ–Ω–Ω–æ /api/auth/login
            // –¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç cookies –±–ª–∞–≥–æ–¥–∞—Ä—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
            const response = await axios.post('http://localhost:8080/api/auth/login', loginData);
            setCurrentUser(response.data);
            return { success: true };
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
            const errorMessage = error.response?.data?.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
            return { success: false, message: errorMessage };
        }
    };

    // —Ñ—É–Ω–∫—Ü–∏—è '—Å–¥–∞—á–∏ —Å–º–µ–Ω—ã' (–≤—ã—Ö–æ–¥). –ø—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –∞–≥–µ–Ω—Ç–µ.
    const logout = () => {
        setCurrentUser(null);
    };

    // —Å–æ–±–∏—Ä–∞–µ–º –≤ –æ–¥–∏–Ω '–ø–∞–∫–µ—Ç' –∏ –¥–∞–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç–∞, –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞.
    const value = { currentUser, login, logout };

    // –¥–µ–ª–∞–µ–º —ç—Ç–æ—Ç '–ø–∞–∫–µ—Ç' –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –≤—Å–µ—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
};

// –∞ —ç—Ç–æ –Ω–∞—à '—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª—é—á' (—Ö—É–∫) –¥–ª—è –ª—é–±–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞,
// –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–µ–Ω –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –∞–≥–µ–Ω—Ç–∞ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è–º –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞.
export const useAuth = () => {
    return useContext(AuthContext);
};